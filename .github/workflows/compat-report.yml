name: Process Compatibility Report

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-report:
    # Only run on issues created via the compatibility report template
    if: contains(github.event.issue.labels.*.name, 'compat-report')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Parse issue and update data
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;

            // â”€â”€ Loop prevention â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // If the issue body contains our sentinel, it was created by
            // the worker or this action â€” skip to avoid infinite loops.
            const SENTINEL = '<!-- xenios-auto -->';
            if (issue.body && issue.body.includes(SENTINEL)) {
              console.log('Skipping: issue was auto-created (sentinel found)');
              return;
            }

            // â”€â”€ Parse issue form fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // GitHub issue forms render as markdown with ### headers.
            // Each form field becomes: ### Label\n\nValue\n\n
            const body = issue.body || '';

            // Parse all ### sections into a map for robust extraction.
            // GitHub issue forms render as: ### Label\n\nValue\n\n### Next...
            const sections = {};
            const sectionRegex = /###\s+(.+)\s*\n([\s\S]*?)(?=\n###|\s*$)/g;
            let sectionMatch;
            while ((sectionMatch = sectionRegex.exec(body)) !== null) {
              const key = sectionMatch[1].trim();
              const val = sectionMatch[2].trim();
              // Skip checkbox sections and _No response_ values
              if (val && val !== '_No response_') {
                sections[key] = val;
              }
            }

            console.log('Parsed sections:', Object.keys(sections));

            function extractField(label) {
              return sections[label] || '';
            }

            // â”€â”€ Extract title ID and game name from issue title â”€â”€
            // Expected format: "[TITLE_ID] â€” [GAME_NAME]" or "TITLE_ID â€” Game Name"
            const titleMatch = issue.title.match(/^\[?([A-Fa-f0-9]{8})\]?\s*[â€”â€“-]\s*\[?(.+?)\]?$/);
            if (!titleMatch) {
              console.log(`Skipping: issue title doesn't match expected format: "${issue.title}"`);
              // Add a comment explaining the format requirement
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: issue.number,
                body: `âš ï¸ Could not parse this report automatically. Please ensure the issue title follows the format:\n\n\`TITLE_ID â€” Game Name\`\n\nExample: \`4D5307E6 â€” Halo 3\`\n\n${SENTINEL}`,
              });
              return;
            }

            const titleId = titleMatch[1].toUpperCase();
            const gameName = titleMatch[2].trim();

            // â”€â”€ Extract form fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const rawPlatform = extractField('Platform');
            const device = extractField('Device');
            const osVersion = extractField('OS Version');
            const rawArch = extractField('Architecture');
            const rawGpuBackend = extractField('GPU Backend');
            const rawStatus = extractField('Compatibility Status');
            const rawPerf = extractField('Performance');
            const notes = extractField('Notes');

            // â”€â”€ Normalize values â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function normalizeDropdown(raw, map) {
              const lower = raw.toLowerCase();
              for (const [key, patterns] of Object.entries(map)) {
                for (const pattern of patterns) {
                  if (lower.includes(pattern)) return key;
                }
              }
              return null;
            }

            const platform = normalizeDropdown(rawPlatform, {
              ios: ['ios'],
              macos: ['macos'],
            });

            const status = normalizeDropdown(rawStatus, {
              playable: ['playable'],
              ingame: ['in-game', 'ingame'],
              intro: ['intro'],
              loads: ['loads'],
              nothing: ['nothing'],
            });

            let perf = normalizeDropdown(rawPerf, {
              great: ['great'],
              ok: ['ok'],
              poor: ['poor'],
              'n/a': ['n/a', 'not applicable'],
            });

            // Auto-set perf to n/a when status is nothing
            if (status === 'nothing' && !perf) perf = 'n/a';

            const arch = normalizeDropdown(rawArch, {
              arm64: ['arm64'],
              x86_64: ['x86_64', 'x86'],
            });

            const gpuBackend = normalizeDropdown(rawGpuBackend, {
              msl: ['msl'],
              msc: ['msc'],
            });

            // â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const errors = [];
            if (!platform) errors.push(`Invalid platform: "${rawPlatform}"`);
            if (!status) errors.push(`Invalid status: "${rawStatus}"`);
            if (!perf) errors.push(`Invalid performance: "${rawPerf}"`);
            if (!arch) errors.push(`Invalid architecture: "${rawArch}"`);
            if (!gpuBackend) errors.push(`Invalid GPU backend: "${rawGpuBackend}"`);
            if (!device) errors.push('Device is required');
            if (!osVersion) errors.push('OS Version is required');
            if (!notes) errors.push('Notes are required');

            if (platform === 'ios' && gpuBackend === 'msc') {
              errors.push('iOS platform only supports MSL GPU backend');
            }

            if (errors.length > 0) {
              console.log('Validation errors:', errors);
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: issue.number,
                body: `âš ï¸ Could not process this report due to validation errors:\n\n${errors.map(e => `- ${e}`).join('\n')}\n\nPlease edit the issue to fix these fields.\n\n${SENTINEL}`,
              });
              return;
            }

            // â”€â”€ Update compatibility.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const games = JSON.parse(fs.readFileSync('data/compatibility.json', 'utf8'));
            const today = new Date().toISOString().slice(0, 10);

            const newReport = {
              device,
              platform,
              osVersion,
              arch,
              gpuBackend,
              status,
              date: today,
              notes,
            };

            const idx = games.findIndex(
              g => g.titleId.toUpperCase() === titleId
            );

            if (idx >= 0) {
              // Update existing game
              const game = games[idx];
              game.reports = [newReport, ...game.reports];
              game.lastReport = { device, platform, osVersion, arch, gpuBackend };
              game.updatedAt = today;
              game.status = status;
              game.perf = perf;
              game.notes = notes;
              if (!game.platforms.includes(platform)) {
                game.platforms.push(platform);
              }
            } else {
              // New game
              const slug = gameName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
              games.push({
                slug,
                title: gameName,
                titleId,
                status,
                perf,
                tags: [],
                platforms: [platform],
                lastReport: { device, platform, osVersion, arch, gpuBackend },
                updatedAt: today,
                notes,
                recommendedSettings: { resolution: '720p', framerate: '30fps' },
                reports: [newReport],
                screenshots: [],
              });
            }

            fs.writeFileSync('data/compatibility.json', JSON.stringify(games, null, 2) + '\n');
            console.log(`Updated compatibility.json for ${gameName} (${titleId})`);

            // â”€â”€ Apply labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const newLabels = [
              'compat-report',
              `state:${status}`,
              `perf:${perf}`,
              `platform:${platform}`,
              `gpu:${gpuBackend}`,
            ];

            await github.rest.issues.setLabels({
              ...context.repo,
              issue_number: issue.number,
              labels: newLabels,
            });

            // â”€â”€ Check for existing canonical issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // If another issue already tracks this game, add a comment
            // linking them and close this one as a duplicate.
            const searchResult = await github.rest.search.issuesAndPullRequests({
              q: `${titleId} repo:${context.repo.owner}/${context.repo.repo} label:compat-report is:issue`,
            });

            const canonical = searchResult.data.items.find(
              i => i.number !== issue.number && i.title.startsWith(`${titleId} `)
            );

            if (canonical) {
              // Add report as comment on canonical issue
              const statusEmoji = { playable: 'âœ…', ingame: 'ğŸŸ¦', intro: 'ğŸŸ¨', loads: 'ğŸŸ§', nothing: 'ğŸ”´' };
              const platformDisplay = platform === 'ios' ? 'iOS' : 'macOS';

              const reportBody = [
                `## Compatibility Report`,
                ``,
                `| Field | Value |`,
                `|-------|-------|`,
                `| **Title** | ${gameName} |`,
                `| **Title ID** | \`${titleId}\` |`,
                `| **Status** | ${statusEmoji[status]} ${status} |`,
                `| **Performance** | ${perf} |`,
                `| **Platform** | ${platformDisplay} |`,
                `| **Device** | ${device} |`,
                `| **OS Version** | ${platformDisplay} ${osVersion} |`,
                `| **Architecture** | ${arch} |`,
                `| **GPU Backend** | ${gpuBackend.toUpperCase()} |`,
                ``,
                `### Notes`,
                notes,
                ``,
                `---`,
                `*Submitted via GitHub issue #${issue.number}*`,
                SENTINEL,
              ].join('\n');

              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: canonical.number,
                body: reportBody,
              });

              // Update canonical issue labels
              const canonLabels = canonical.labels.map(l => l.name)
                .filter(l => !l.startsWith('state:') && !l.startsWith('perf:'));
              canonLabels.push(`state:${status}`, `perf:${perf}`, `platform:${platform}`, `gpu:${gpuBackend}`);
              const uniqueLabels = [...new Set(canonLabels)];

              await github.rest.issues.setLabels({
                ...context.repo,
                issue_number: canonical.number,
                labels: uniqueLabels,
              });

              // Close this issue as duplicate
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: issue.number,
                body: `âœ… Report processed! This game already has a tracking issue: #${canonical.number}. Your report has been added there.\n\n${SENTINEL}`,
              });

              await github.rest.issues.update({
                ...context.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'not_planned',
              });

              console.log(`Merged into canonical issue #${canonical.number}`);
            } else {
              // This becomes the canonical issue â€” add sentinel to body
              const updatedBody = issue.body + `\n\n${SENTINEL}`;
              await github.rest.issues.update({
                ...context.repo,
                issue_number: issue.number,
                body: updatedBody,
              });
              console.log(`Issue #${issue.number} is now the canonical issue for ${titleId}`);
            }

            // â”€â”€ Post to Discord â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const webhookUrl = process.env.DISCORD_WEBHOOK;
            if (webhookUrl) {
              const statusColors = {
                playable: 0x34d399, ingame: 0x60a5fa,
                intro: 0xfbbf24, loads: 0xfb923c, nothing: 0xf87171,
              };
              const statusLabels = {
                playable: 'âœ… Playable', ingame: 'ğŸŸ¦ In-Game',
                intro: 'ğŸŸ¨ Intro', loads: 'ğŸŸ§ Loads', nothing: "ğŸ”´ Doesn't Boot",
              };
              const perfLabels = { great: 'ğŸš€ Great', ok: 'ğŸ‘Œ OK', poor: 'ğŸ¢ Poor' };
              const platformLabels = { ios: 'ğŸ“± iOS', macos: 'ğŸ–¥ï¸ macOS' };
              const platformDisplay = platform === 'ios' ? 'iOS' : 'macOS';

              const issueUrl = canonical
                ? `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${canonical.number}`
                : issue.html_url;

              const embed = {
                title: gameName,
                description: notes.slice(0, 200),
                color: statusColors[status],
                fields: [
                  { name: 'Status', value: statusLabels[status], inline: true },
                  { name: 'Performance', value: perfLabels[perf], inline: true },
                  { name: 'Title ID', value: `\`${titleId}\``, inline: true },
                  { name: 'Platform', value: platformLabels[platform], inline: true },
                  { name: 'Device', value: device, inline: true },
                  { name: 'OS Version', value: `${platformDisplay} ${osVersion}`, inline: true },
                  { name: 'Architecture', value: arch.toUpperCase(), inline: true },
                  { name: 'GPU Backend', value: gpuBackend.toUpperCase(), inline: true },
                  { name: 'GitHub Issue', value: `[View](${issueUrl})`, inline: true },
                ],
                footer: { text: 'XeniOS Compatibility Report â€¢ via GitHub Issue' },
                timestamp: new Date().toISOString(),
              };

              try {
                await fetch(webhookUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ embeds: [embed] }),
                });
                console.log('Discord notification sent');
              } catch (e) {
                console.error('Discord webhook failed:', e);
              }
            }

      - name: Commit updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/compatibility.json
          git diff --staged --quiet && echo "No changes to commit" || \
            git commit -m "compat: update from issue #${{ github.event.issue.number }} [skip ci]" && git push
