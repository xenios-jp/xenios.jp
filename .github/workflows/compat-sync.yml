name: Sync Compatibility Table

on:
  push:
    paths:
      - "data/compatibility.json"
    branches:
      - main

permissions:
  contents: write

jobs:
  generate-table:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate COMPATIBILITY.md
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const games = JSON.parse(fs.readFileSync('data/compatibility.json', 'utf8'));

            const statusEmoji = {
              playable: 'ðŸŸ¢',
              ingame:   'ðŸ”µ',
              intro:    'ðŸŸ¡',
              loads:    'ðŸŸ ',
              nothing:  'ðŸ”´',
            };

            const statusLabel = {
              playable: 'Playable',
              ingame:   'In-Game',
              intro:    'Intro',
              loads:    'Loads',
              nothing:  "Doesn't Boot",
            };

            const perfLabel = {
              great: 'ðŸš€ Great',
              ok:    'ðŸ‘Œ OK',
              poor:  'ðŸ¢ Poor',
              'n/a': 'âž– N/A',
            };

            const platformLabel = {
              ios:   'ðŸ“± iOS',
              macos: 'ðŸ–¥ï¸ macOS',
            };

            // Sort: playable first, then alphabetically within each status
            const statusOrder = ['playable', 'ingame', 'intro', 'loads', 'nothing'];
            const sorted = [...games].sort((a, b) => {
              const si = statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
              return si !== 0 ? si : a.title.localeCompare(b.title);
            });

            // Stats
            const total = games.length;
            const counts = {};
            statusOrder.forEach(s => counts[s] = 0);
            games.forEach(g => counts[g.status]++);

            const platformCounts = { ios: 0, macos: 0 };
            games.forEach(g => {
              (g.platforms || []).forEach(p => {
                if (platformCounts[p] !== undefined) platformCounts[p]++;
              });
            });

            const statsLine = statusOrder
              .map(s => `${statusEmoji[s]} ${statusLabel[s]}: **${counts[s]}**`)
              .join(' Â· ');

            const platformLine = Object.entries(platformCounts)
              .filter(([, count]) => count > 0)
              .map(([p, count]) => `${platformLabel[p]}: **${count}**`)
              .join(' Â· ');

            // Table rows
            const rows = sorted.map(g => {
              const platforms = (g.platforms || []).map(p => platformLabel[p] || p).join(', ');
              return `| ${statusEmoji[g.status]} | ${g.title} | \`${g.titleId}\` | ${platforms} | ${statusLabel[g.status]} | ${perfLabel[g.perf]} | ${g.lastReport.device} | ${g.updatedAt} |`;
            }).join('\n');

            const md = [
              `# XeniOS Compatibility List`,
              ``,
              `> **${total} games tested** â€” auto-generated from [\`data/compatibility.json\`](data/compatibility.json)`,
              `>`,
              `> ${statsLine}`,
              `>`,
              `> ${platformLine}`,
              ``,
              `## Legend`,
              ``,
              `| Emoji | Status | Description |`,
              `|-------|--------|-------------|`,
              `| ðŸŸ¢ | Playable | Game can be played start to finish with minor issues |`,
              `| ðŸ”µ | In-Game | Reaches gameplay but has significant issues |`,
              `| ðŸŸ¡ | Intro | Gets past loading but crashes before/during gameplay |`,
              `| ðŸŸ  | Loads | Boots and shows menus but can't reach gameplay |`,
              `| ðŸ”´ | Doesn't Boot | Does not boot or crashes immediately |`,
              ``,
              `## Games`,
              ``,
              `| | Title | Title ID | Platform | Status | Perf | Last Device | Updated |`,
              `|-|-------|----------|----------|--------|------|-------------|---------|`,
              rows,
              ``,
              `---`,
              ``,
              `*Updated automatically when compatibility data changes. Visit [xenios.jp/compatibility](https://xenios.jp/compatibility) for the full interactive list.*`,
              ``,
            ].join('\n');

            fs.writeFileSync('COMPATIBILITY.md', md);
            console.log(`Generated COMPATIBILITY.md with ${total} games`);

      - name: Commit COMPATIBILITY.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add COMPATIBILITY.md
          if ! git diff --staged --quiet; then
            git pull --rebase
            git commit -m "docs: update COMPATIBILITY.md [skip ci]"
            git push
          else
            echo "No changes"
          fi
